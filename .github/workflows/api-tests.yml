name: API Test Automation

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  schedule:
    # Run nightly at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      test_type:
        description: 'Test type to run'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - smoke
          - integration
          - e2e
          - performance
      environment:
        description: 'Target environment'
        required: true
        default: 'test'
        type: choice
        options:
          - test
          - staging
          - production

env:
  NODE_VERSION: '20'
  TEST_ENV: ${{ github.event.inputs.environment || 'test' }}

jobs:
  # Smoke tests run first and fast
  smoke-tests:
    name: Smoke Tests
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run smoke tests
        env:
          API_BASE_URL: ${{ secrets.API_BASE_URL_TEST }}
          AUTH_USERNAME: ${{ secrets.TEST_USERNAME }}
          AUTH_PASSWORD: ${{ secrets.TEST_PASSWORD }}
        run: npm run test:smoke

      - name: Upload smoke test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: smoke-test-results
          path: |
            reports/
            test-results/
          retention-days: 30

      - name: Publish smoke test report
        if: always()
        uses: dorny/test-reporter@v1
        with:
          name: Smoke Test Results
          path: reports/junit/results.xml
          reporter: java-junit

  # Integration tests run in parallel
  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: smoke-tests
    if: ${{ !cancelled() && needs.smoke-tests.result == 'success' }}

    strategy:
      fail-fast: false
      matrix:
        shard: [1, 2, 3, 4]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run integration tests (Shard ${{ matrix.shard }}/4)
        env:
          API_BASE_URL: ${{ secrets.API_BASE_URL_TEST }}
          AUTH_USERNAME: ${{ secrets.TEST_USERNAME }}
          AUTH_PASSWORD: ${{ secrets.TEST_PASSWORD }}
        run: npm run test:integration -- --shard=${{ matrix.shard }}/4

      - name: Upload integration test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: integration-test-results-${{ matrix.shard }}
          path: |
            reports/
            test-results/
          retention-days: 30

  # E2E tests run after integration
  e2e-tests:
    name: End-to-End Tests
    runs-on: ubuntu-latest
    timeout-minutes: 45
    needs: integration-tests
    if: ${{ !cancelled() && needs.integration-tests.result == 'success' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run E2E tests
        env:
          API_BASE_URL: ${{ secrets.API_BASE_URL_TEST }}
          AUTH_USERNAME: ${{ secrets.TEST_USERNAME }}
          AUTH_PASSWORD: ${{ secrets.TEST_PASSWORD }}
        run: npm run test:e2e

      - name: Upload E2E test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-test-results
          path: |
            reports/
            test-results/
          retention-days: 30

      - name: Upload screenshots on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-failure-screenshots
          path: test-results/*/screenshots/
          retention-days: 30

  # Performance tests run separately
  performance-tests:
    name: Performance Tests
    runs-on: ubuntu-latest
    timeout-minutes: 60
    needs: smoke-tests
    if: |
      github.event_name == 'schedule' ||
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'push' && github.ref == 'refs/heads/main')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run performance tests
        env:
          API_BASE_URL: ${{ secrets.API_BASE_URL_TEST }}
          AUTH_USERNAME: ${{ secrets.TEST_USERNAME }}
          AUTH_PASSWORD: ${{ secrets.TEST_PASSWORD }}
        run: npm run test:performance

      - name: Upload performance results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: performance-test-results
          path: reports/
          retention-days: 90

      - name: Check performance thresholds
        run: |
          echo "Checking performance thresholds..."
          # Add custom threshold checking logic here

  # Aggregate results and report
  report:
    name: Aggregate Results & Report
    runs-on: ubuntu-latest
    needs: [smoke-tests, integration-tests, e2e-tests]
    if: always()

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: all-reports

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install dependencies
        run: npm ci

      - name: Aggregate test reports
        run: |
          echo "Aggregating test reports..."
          mkdir -p reports/aggregated
          # Custom aggregation logic would go here

      - name: Publish test results
        uses: dorny/test-reporter@v1
        if: always()
        with:
          name: All Test Results
          path: 'all-reports/**/reports/junit/results.xml'
          reporter: java-junit

      - name: Generate test summary
        if: always()
        run: |
          echo "## Test Execution Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Results by Test Type" >> $GITHUB_STEP_SUMMARY
          echo "| Test Type | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Smoke | ${{ needs.smoke-tests.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Integration | ${{ needs.integration-tests.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| E2E | ${{ needs.e2e-tests.result }} |" >> $GITHUB_STEP_SUMMARY

      - name: Upload aggregated reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: aggregated-test-reports
          path: reports/
          retention-days: 90

      - name: Comment PR with results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const reportPath = 'reports/custom/test-report.json';

            if (fs.existsSync(reportPath)) {
              const report = JSON.parse(fs.readFileSync(reportPath, 'utf8'));

              const body = `## API Test Results

              **Summary:**
              - Total: ${report.summary.total}
              - Passed: ${report.summary.passed} ✅
              - Failed: ${report.summary.failed} ❌
              - Skipped: ${report.summary.skipped} ⏭️
              - Duration: ${Math.round(report.summary.duration / 1000)}s

              **Pass Rate:** ${Math.round((report.summary.passed / report.summary.total) * 100)}%

              [View Full Report](${process.env.GITHUB_SERVER_URL}/${process.env.GITHUB_REPOSITORY}/actions/runs/${process.env.GITHUB_RUN_ID})
              `;

              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: body
              });
            }

  # Notify on failure
  notify:
    name: Notify on Failure
    runs-on: ubuntu-latest
    needs: [smoke-tests, integration-tests, e2e-tests]
    if: failure() && (github.event_name == 'push' || github.event_name == 'schedule')

    steps:
      - name: Send Slack notification
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          text: 'API tests failed on ${{ github.ref }}'
          webhook_url: ${{ secrets.SLACK_WEBHOOK }}
        if: always()
